<!DOCTYPE html>
<html>
<head>
    <title>Dashboard Histórico</title>
    <a href="/logout">Cerrar sesión</a>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>

    <h1>Histórico de Análisis</h1>

    <h2>Resumen</h2>

    <p><strong>Total análisis:</strong> {{ total_analisis }}</p>

    <p><strong>Nivel de riesgo actual:</strong>
    {% if ultimo_nivel == "BAJO" %}
        <span style="color:green;"><strong>{{ ultimo_nivel }}</strong></span>
    {% elif ultimo_nivel == "MODERADO" %}
        <span style="color:orange;"><strong>{{ ultimo_nivel }}</strong></span>
    {% elif ultimo_nivel == "ALTO" %}
        <span style="color:red;"><strong>{{ ultimo_nivel }}</strong></span>
    {% elif ultimo_nivel == "CRÍTICO" %}
        <span style="color:darkred;"><strong>{{ ultimo_nivel }}</strong></span>
    {% else %}
        {{ ultimo_nivel }}
    {% endif %}
    </p>

    <p>
        <strong>Problema más frecuente histórico:</strong>
        {{ problema_frecuente }}
        ({{ frecuencia_problema }} veces)
    </p>

    <p>
        <strong>Problema dominante en los últimos 3 análisis:</strong>
        {{ problema_reciente }}
    </p>

    <p>
        <strong>Promedio porcentaje problema:</strong>
        {% if promedio %}
            {{ "%.1f"|format(promedio) }}%
        {% else %}
            0%
        {% endif %}
    </p>

    <hr>

    <h2>Distribución de Problemas</h2>
    <canvas id="graficoProblemas" width="600" height="300"></canvas>

    <hr>

    <table border="1">
        <tr>
            <th>Fecha</th>
            <th>Problema</th>
            <th>Nivel de Riesgo</th>
            <th>Porcentaje</th>
        </tr>

        {% for fila in datos %}
        <tr>
            <td>{{ fila[0] }}</td>
            <td>{{ fila[1] }}</td>
            <td>{{ fila[2] }}</td>
            <td>{{ "%.1f"|format(fila[3]) }}%</td>
        </tr>
        {% endfor %}

    </table>

    <script>
        const ctx = document.getElementById('graficoProblemas').getContext('2d');

        const grafico = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: {{ labels | tojson }},
                datasets: [{
                    label: 'Frecuencia de Problemas',
                    data: {{ valores | tojson }},
                    backgroundColor: [
                        'rgba(255, 99, 132, 0.6)',
                        'rgba(54, 162, 235, 0.6)',
                        'rgba(255, 206, 86, 0.6)',
                        'rgba(75, 192, 192, 0.6)'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    </script>

</body>
</html>